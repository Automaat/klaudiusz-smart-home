name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  nix-checks:
    name: Nix Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Flake Check
        if: steps.changes.outputs.nix == 'true'
        run: nix flake check --show-trace

      - name: Build homelab system
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#nixosConfigurations.homelab.config.system.build.toplevel --show-trace

  format-check:
    name: Nix Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Check Nix formatting
        if: steps.changes.outputs.nix == 'true'
        run: |
          nix fmt -- --check .

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for YAML changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            yaml:
              - '**/*.yaml'
              - '**/*.yml'

      - name: Install yamllint
        if: steps.changes.outputs.yaml == 'true'
        run: pip install yamllint

      - name: Lint YAML files
        if: steps.changes.outputs.yaml == 'true'
        run: yamllint custom_sentences/

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Markdown changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            markdown:
              - '**/*.md'

      - name: Lint Markdown
        if: steps.changes.outputs.markdown == 'true'
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: '**/*.md'

  action-lint:
    name: Action Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for workflow changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            workflows:
              - '.github/workflows/**'

      - name: Install mise
        if: steps.changes.outputs.workflows == 'true'
        uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2

      - name: Lint GitHub Actions workflows
        if: steps.changes.outputs.workflows == 'true'
        run: actionlint
