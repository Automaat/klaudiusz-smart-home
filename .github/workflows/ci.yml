name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  enhanced-validation-ha-official:
    name: Enhanced Validation (HA Official)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for config changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            ha_config:
              - 'hosts/homelab/home-assistant/**'
              - 'custom_sentences/**/*.yaml'

      - name: Install Nix
        if: steps.changes.outputs.ha_config == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Extract HA config for validation
        if: steps.changes.outputs.ha_config == 'true'
        run: |
          mkdir -p .ha-config
          # Generate config from Nix
          nix eval --raw .#nixosConfigurations.homelab.config.services.home-assistant.config --apply 'x: builtins.toJSON x' | \
            nix run nixpkgs#yq-go -- -P > .ha-config/configuration.yaml

      - name: Run Home Assistant Config Check
        if: steps.changes.outputs.ha_config == 'true'
        uses: frenck/action-home-assistant@v1
        with:
          path: .ha-config
          version: stable

  enhanced-validation-jinja2:
    name: Enhanced Validation (Jinja2)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Run Jinja2 Template Validation
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.jinja2-validation --show-trace --max-jobs auto

  enhanced-validation-entity-references:
    name: Enhanced Validation (Entity References)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Run Entity Reference Validation
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.entity-references --show-trace --max-jobs auto

  static-tests:
    name: Static Tests
    runs-on: ubuntu-latest
    needs: [format, yaml-lint, markdown-lint, action-lint, enhanced-validation-ha-official, enhanced-validation-jinja2, enhanced-validation-entity-references]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Flake Check
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.all-static-tests --show-trace --max-jobs auto

      - name: Build homelab system
        if: steps.changes.outputs.nix == 'true' && github.event_name == 'push'
        run: nix build .#nixosConfigurations.homelab.config.system.build.toplevel --show-trace --max-jobs auto

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Check Nix formatting
        if: steps.changes.outputs.nix == 'true'
        run: |
          nix fmt -- --check .

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for YAML changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            yaml:
              - '**/*.yaml'
              - '**/*.yml'

      - name: Install yamllint
        if: steps.changes.outputs.yaml == 'true'
        run: pip install yamllint

      - name: Lint YAML files
        if: steps.changes.outputs.yaml == 'true'
        run: yamllint custom_sentences/

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Markdown changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            markdown:
              - '**/*.md'

      - name: Lint Markdown
        if: steps.changes.outputs.markdown == 'true'
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: '**/*.md'

  action-lint:
    name: Action Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for workflow changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            workflows:
              - '.github/workflows/**'

      - name: Install mise
        if: steps.changes.outputs.workflows == 'true'
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

      - name: Lint GitHub Actions workflows
        if: steps.changes.outputs.workflows == 'true'
        run: actionlint

  integration-tests:
    name: Integration Tests (Main Only)
    runs-on: ubuntu-latest
    needs: [static-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Enable KVM (for VM tests)
        if: steps.changes.outputs.nix == 'true'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

          # Verify that /dev/kvm is available and writable for this runner
          if [ -e /dev/kvm ]; then
            echo "/dev/kvm detected after udev trigger:"
            ls -la /dev/kvm
            if [ -w /dev/kvm ]; then
              echo "KVM device is writable; proceeding with hardware-accelerated tests."
            else
              echo "::warning::/dev/kvm exists but is not writable; integration tests may run without KVM acceleration."
            fi
          else
            echo "::warning::/dev/kvm not found after udev trigger; integration tests will run without KVM acceleration."
          fi

      - name: Run integration tests
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.all-integration-tests --show-trace --max-jobs auto

  update-production:
    name: Update Production Branch
    runs-on: ubuntu-latest
    needs: [static-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - run: git push origin HEAD:production
