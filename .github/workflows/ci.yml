name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  enhanced-validation-ha-official:
    name: Enhanced Validation (HA Official)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for config changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            ha_config:
              - 'hosts/homelab/home-assistant/**'
              - 'custom_sentences/**/*.yaml'

      - name: Install Nix
        if: steps.changes.outputs.ha_config == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Extract HA config for validation
        if: steps.changes.outputs.ha_config == 'true'
        run: |
          mkdir -p .ha-config
          # Generate config from Nix
          # Filter: null values (deprecated), frontend.themes (!include directive incompatible with validator)
          # Use Python yaml instead of yq to avoid conversion bugs with large nested structures
          nix eval --raw .#nixosConfigurations.homelab.config.services.home-assistant.config --apply 'x: builtins.toJSON x' | \
            nix run nixpkgs#jq -- 'del(..|select(. == null)) | del(.frontend.themes)' | \
            python3 .github/scripts/json-to-yaml.py > .ha-config/configuration.yaml

      - name: Run Home Assistant Config Check
        if: steps.changes.outputs.ha_config == 'true'
        uses: frenck/action-home-assistant@941d5d917f4c1c7a7e7d4087526daf90d53f4437 # v1
        with:
          path: .ha-config
          version: stable

  enhanced-validation-jinja2:
    name: Enhanced Validation (Jinja2)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Run Jinja2 Template Validation
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.jinja2-validation --show-trace --max-jobs auto

  enhanced-validation-entity-references:
    name: Enhanced Validation (Entity References)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Run Entity Reference Validation
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.entity-references --show-trace --max-jobs auto

  pytest:
    name: Python Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Python changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            python:
              - 'custom_components/**/*.py'
              - 'tests/**/*.py'
              - 'requirements-dev.txt'
              - 'pytest.ini'

      - name: Set up Python
        if: steps.changes.outputs.python == 'true'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        if: steps.changes.outputs.python == 'true'
        run: pip install -r requirements-dev.txt

      - name: Run pytest
        if: steps.changes.outputs.python == 'true'
        run: pytest --cov=custom_components/deepgram_stt --cov-report=term --cov-report=xml

      - name: Upload coverage
        if: steps.changes.outputs.python == 'true'
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  static-tests:
    name: Static Tests
    runs-on: ubuntu-24.04
    needs: [format, yaml-lint, markdown-lint, action-lint, shellcheck, enhanced-validation-ha-official, enhanced-validation-jinja2, enhanced-validation-entity-references, pytest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Flake Check
        if: steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: nix build .#checks.x86_64-linux.all-static-tests --show-trace --max-jobs auto

      - name: Build homelab system
        if: (steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && github.event_name == 'push'
        run: nix build .#nixosConfigurations.homelab.config.system.build.toplevel --show-trace --max-jobs auto

  format:
    name: Format Check
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Check Nix formatting
        if: steps.changes.outputs.nix == 'true'
        run: |
          nix fmt -- --check .

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for YAML changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            yaml:
              - '**/*.yaml'
              - '**/*.yml'

      - name: Install yamllint
        if: steps.changes.outputs.yaml == 'true'
        run: pip install yamllint

      - name: Lint YAML files
        if: steps.changes.outputs.yaml == 'true'
        run: yamllint custom_sentences/

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Markdown changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            markdown:
              - '**/*.md'

      - name: Lint Markdown
        if: steps.changes.outputs.markdown == 'true'
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: '**/*.md'

  action-lint:
    name: Action Lint
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for workflow changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            workflows:
              - '.github/workflows/**'

      - name: Install mise
        if: steps.changes.outputs.workflows == 'true'
        uses: jdx/mise-action@c53b9236f0b3370f31520f8b142f141256d839c6 # v3

      - name: Lint GitHub Actions workflows
        if: steps.changes.outputs.workflows == 'true'
        run: actionlint

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for shell script changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            shell:
              - '**/*.sh'
              - '**/*.nix'

      - name: Run ShellCheck
        if: steps.changes.outputs.shell == 'true'
        uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # v2.0.0
        with:
          severity: warning

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: [format, yaml-lint, markdown-lint, action-lint, shellcheck, enhanced-validation-ha-official, enhanced-validation-jinja2, enhanced-validation-entity-references, pytest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Enable KVM (for VM tests)
        if: steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

          # Verify that /dev/kvm is available and writable for this runner
          if [ -e /dev/kvm ]; then
            echo "/dev/kvm detected after udev trigger:"
            ls -la /dev/kvm
            if [ -w /dev/kvm ]; then
              echo "KVM device is writable; proceeding with hardware-accelerated tests."
            else
              echo "::warning::/dev/kvm exists but is not writable; integration tests may run without KVM acceleration."
            fi
          else
            echo "::warning::/dev/kvm not found after udev trigger; integration tests will run without KVM acceleration."
          fi

      - name: Run integration tests
        if: steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          set -o pipefail
          nix build .#checks.x86_64-linux.all-integration-tests --show-trace --max-jobs auto 2>&1 | tee integration-test.log || {
            # Extract failing derivation path and get full logs
            FAILED_DRV=$(grep -oP "nix log /nix/store/[^\s]+" integration-test.log | head -1 | sed 's/nix log //')
            if [ -n "$FAILED_DRV" ]; then
              echo "Extracting full logs from: $FAILED_DRV"
              nix log "$FAILED_DRV" > integration-test-full.log 2>&1 || echo "Could not extract full logs"
            fi
            exit 1
          }

      - name: Upload test logs on failure
        if: failure() && (steps.changes.outputs.nix == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main'))
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: integration-test-logs
          path: |
            integration-test.log
            integration-test-full.log
          retention-days: 30

  update-production:
    name: Update Production Branch
    runs-on: ubuntu-24.04
    needs: [static-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    concurrency:
      group: production-branch-update
      cancel-in-progress: false
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - run: git push --force-with-lease origin HEAD:production
