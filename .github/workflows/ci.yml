name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  nix-flake-check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    needs: [format, yaml-lint, markdown-lint, action-lint]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Restore Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-flake-check-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-flake-check-${{ runner.os }}-
          gc-max-store-size: 3221225472

      - name: Flake Check
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.all-static-tests --show-trace --max-jobs auto

      - name: Save Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-flake-check-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          gc-max-store-size: 3221225472

  build-homelab:
    name: Build Homelab System
    runs-on: ubuntu-latest
    needs: [format, yaml-lint, markdown-lint, action-lint]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Restore Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-build-homelab-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-build-homelab-${{ runner.os }}-
          gc-max-store-size: 4294967296

      - name: Build homelab system
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#nixosConfigurations.homelab.config.system.build.toplevel --show-trace --max-jobs auto

      - name: Export system closure
        if: steps.changes.outputs.nix == 'true'
        run: nix-store -qR result | xargs nix-store --export | zstd -T0 -10 > homelab-system.nar.zst

      - name: Upload system artifact
        if: steps.changes.outputs.nix == 'true'
        uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097 # v4
        with:
          name: homelab-system
          path: homelab-system.nar.zst
          retention-days: 7

      - name: Save Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-build-homelab-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          gc-max-store-size: 4294967296

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Restore Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-format-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-format-${{ runner.os }}-
          gc-max-store-size: 1073741824

      - name: Check Nix formatting
        if: steps.changes.outputs.nix == 'true'
        run: |
          nix fmt -- --check .

      - name: Save Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-format-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          gc-max-store-size: 1073741824

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for YAML changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            yaml:
              - '**/*.yaml'
              - '**/*.yml'

      - name: Setup pip cache
        if: steps.changes.outputs.yaml == 'true'
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-yamllint
          restore-keys: pip-${{ runner.os }}-

      - name: Install yamllint
        if: steps.changes.outputs.yaml == 'true'
        run: pip install yamllint

      - name: Lint YAML files
        if: steps.changes.outputs.yaml == 'true'
        run: yamllint custom_sentences/

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Markdown changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            markdown:
              - '**/*.md'

      - name: Lint Markdown
        if: steps.changes.outputs.markdown == 'true'
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: '**/*.md'

  action-lint:
    name: Action Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for workflow changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            workflows:
              - '.github/workflows/**'

      - name: Setup mise cache
        if: steps.changes.outputs.workflows == 'true'
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('.mise.toml') }}
          restore-keys: mise-${{ runner.os }}-

      - name: Install mise
        if: steps.changes.outputs.workflows == 'true'
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

      - name: Lint GitHub Actions workflows
        if: steps.changes.outputs.workflows == 'true'
        run: actionlint

  integration-tests:
    name: Integration Tests (Main Only)
    runs-on: ubuntu-latest
    needs: [nix-flake-check, build-homelab]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check for Nix changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
              - 'custom_sentences/**/*.yaml'
              - 'tests/**'

      - name: Install Nix
        if: steps.changes.outputs.nix == 'true'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Restore Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-integration-tests-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-integration-tests-${{ runner.os }}-
          gc-max-store-size: 2147483648

      - name: Download homelab system artifact
        if: steps.changes.outputs.nix == 'true'
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: homelab-system

      - name: Import homelab system to Nix store
        if: steps.changes.outputs.nix == 'true'
        run: zstd -d homelab-system.nar.zst --stdout | nix-store --import

      - name: Enable KVM (for VM tests)
        if: steps.changes.outputs.nix == 'true'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

          # Verify that /dev/kvm is available and writable for this runner
          if [ -e /dev/kvm ]; then
            echo "/dev/kvm detected after udev trigger:"
            ls -la /dev/kvm
            if [ -w /dev/kvm ]; then
              echo "KVM device is writable; proceeding with hardware-accelerated tests."
            else
              echo "::warning::/dev/kvm exists but is not writable; integration tests may run without KVM acceleration."
            fi
          else
            echo "::warning::/dev/kvm not found after udev trigger; integration tests will run without KVM acceleration."
          fi

      - name: Run integration tests
        if: steps.changes.outputs.nix == 'true'
        run: nix build .#checks.x86_64-linux.all-integration-tests --show-trace --max-jobs auto

      - name: Save Nix cache
        if: steps.changes.outputs.nix == 'true'
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-integration-tests-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          gc-max-store-size: 2147483648

  update-production:
    name: Update Production Branch
    runs-on: ubuntu-latest
    needs: [nix-flake-check, build-homelab, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - run: git push origin HEAD:production
